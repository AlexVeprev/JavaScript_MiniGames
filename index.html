<!DOCTYPE html>
<html>
  <head>
    <title>AV: JavaScript MiniGames</title>
    <link rel="stylesheet" type="text/css" href="style.css">

      <script type="text/javascript">
        "use strict";
        var timer = null;
        var game = null;
        var canvas = null;

        function startTimer() {
          if (game) {
            var interval = 2000 / parseInt(document.getElementById('timer_interval').value);
            timer = setInterval(game.step, interval);
            return;
          }
          alert("Nothing to start.");
        }

        function stopTimer() {
          if (timer) {
            clearInterval(timer);
            timer = null;
          }
        }

        function chooseGame() {
          var chosenGame = "Game of life";
          var fieldSize = {width:  parseInt(document.getElementById('field_size').value),
                           height: parseInt(document.getElementById('field_size').value)};
          canvas = document.getElementById("canvas");

          if (chosenGame == "Game of life") {
            game = new GameOfLife(fieldSize, canvas, getCanvasSize(), document.getElementById('chbx_display_grid'));
            game.registerCallback("gameover", gameOver);
            game.registerCallback("statistics", GameOfLife_statistics);
          }
          else if (chosenGame == "Snake") {
            game = new Snake(fieldSize, canvas, getCanvasSize(), document.getElementById('chbx_display_grid'));
            game.registerCallback("gameover", gameOver);
          }
        }

        function GameOfLife_statistics(statistics) {
          document.getElementById('lbl_gol_number_of_generations').innerHTML =
          "Number of generations: " + statistics.numberOfGenerations;
          document.getElementById('lbl_gol_initial_generation').innerHTML =
          "Size of initial generation: " + statistics.initialGeneration;
          var result = null;

          if (statistics.finalGeneration !== undefined) {
            document.getElementById('lbl_gol_final_generation').innerHTML =
            "Size of final generation: " + statistics.finalGeneration;

            result = statistics.finalGeneration > 0 ? "population became stable" : "population died out";
            document.getElementById('lbl_gol_result').innerHTML =
            "Result: " + result;

            var vitality = Math.round(statistics.finalGeneration / statistics.initialGeneration * 10000) / 100;
            document.getElementById('lbl_gol_population_vitality').innerHTML =
            "Population vitality: " + vitality + " %";
          }
          else {
            document.getElementById('lbl_gol_final_generation').innerHTML =
            "Size of final generation: unknown";

            result = statistics.finalGeneration > 0 ? "population became stable" : "population died out";
            document.getElementById('lbl_gol_result').innerHTML =
            "Result: unknown";

            document.getElementById('lbl_gol_population_vitality').innerHTML =
            "Population vitality: unknown";
          }
        }

        function gameOver() {
          stopTimer();
        }

        function relMouseCoords(event) {
          var totalOffsetX = 0;
          var totalOffsetY = 0;
          var canvasX = 0;
          var canvasY = 0;
          var currentElement = this;

          do {
            totalOffsetX += currentElement.offsetLeft - currentElement.scrollLeft;
            totalOffsetY += currentElement.offsetTop - currentElement.scrollTop;
          }
          while (currentElement = currentElement.offsetParent)

          canvasX = event.pageX - totalOffsetX;
          canvasY = event.pageY - totalOffsetY;

          return {x:canvasX, y:canvasY}
        }
        HTMLCanvasElement.prototype.relMouseCoords = relMouseCoords;

        function handleClick(e) {
          var coords = canvas.relMouseCoords(e);
          game.handleClick(coords.x, coords.y);
        }

        window.onkeydown = function(e) {
          e = e || event;
          game.handleKeyDown(e.keyCode);
        };

        function updateFieldSize() {
          var label = document.getElementById('lbl_field_size');
          var range = document.getElementById('field_size');
          game.reset();
          chooseGame();
        }

        function updateTimerSpeed() {
          if (timer) {
            stopTimer();
            startTimer();
          }
        }
        
        function getCanvasSize() {
          var size = window.innerHeight < window.innerWidth - 300 ? window.innerHeight : window.innerWidth - 300;
          var normalizedSize = Math.round(size * 0.9 / 10) * 10;
          return {width: normalizedSize, height: normalizedSize};
        }
        
        window.onresize = function(e) {
          game.resizeCanvas(getCanvasSize());
        };
      </script>

      <script type="text/javascript" src="MatrixPainter.js"></script>
      <script type="text/javascript" src="GameOfLife.js"></script>
      <script type="text/javascript" src="Snake.js"></script>
  </head>

<body onload=chooseGame();>
  <table id="content">
    <tr>
      <td id="controls">
        <table id="general_controls">
          <caption>General controls</caption>
          <tr>
            <td><div class="button" onclick="startTimer();" id="btn_start" >Start</div></td>
            <td><div class="button" onclick="stopTimer();"  >Pause</div></td>
            <td><div class="button" onclick="game.reset();" >Reset</div></td>
          </tr>
          <tr>
            <td>
              Field size
            </td>
            <td colspan="2">
              <input type="range" min="5" max="200" step="1" value="20" id="field_size" oninput="updateFieldSize();">
            </td>
          </tr>
          <tr>
            <td>
              Display grid
            </td>
            <td colspan="2">
              <input type="checkbox" id="chbx_display_grid" checked onchange="game.draw();">
            </td>
          </tr>
        </table>
        <table id="game_of_life_controls">
          <caption>Game of Life</caption>
          <tr>
            <td>
              <div class="button" onclick="game.step();">
                Step
              </div>
            </td>
            <td>
              <div class="button" onclick="game.random(parseFloat(document.getElementById('range_gol_probability').value));">Populate</div>
            </td>
            <td>
              
            </td>
          </tr>
          <tr>
            <td>
              Probability
            </td>
            <td colspan="2">
              <input type="range" min="0.05" max="1" step="0.05" value="0.5" id="range_gol_probability">
            </td>
          </tr>
          <tr>
            <td>
              Speed
            </td>
            <td colspan="2">
              <input type="range" min="1" max="200" step="1" value="100" id="timer_interval" oninput="updateTimerSpeed();">
            </td>
          </tr>
          <tr>
            <td colspan="3">STATISTICS</td>
          </tr>
          <tr>
            <td colspan="3" class="statistics" id="lbl_gol_result">Result: unknown</td>
          </tr>
          <tr>
            <td colspan="3" class="statistics" id="lbl_gol_population_vitality">Population vitality: unknown</td>
          </tr>
          <tr>
            <td colspan="3" class="statistics" id="lbl_gol_number_of_generations">Number of generations: unknown</td>
          </tr>
          <tr>
            <td colspan="3" class="statistics" id="lbl_gol_initial_generation">Size of initial generation: unknown</td>
          </tr>
          <tr>
            <td colspan="3" class="statistics" id="lbl_gol_final_generation">Size of final generation: unknown</td>
          </tr>
        </table>
      </td>
      <td id="game_field">
        <canvas id="canvas" onclick="handleClick(event);" onselectstart="return false" onmousedown="return false"></canvas>
      </td>
    </tr>
  </table>
</body>
</html>